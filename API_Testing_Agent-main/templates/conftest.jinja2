"""
Pytest configuration and fixtures for API Testing Agent.

Auto-generated by API Testing Agent
"""

import pytest
import requests
import logging
from pathlib import Path
from dotenv import load_dotenv
from src.config import Config

logger = logging.getLogger(__name__)


@pytest.fixture(scope="session")
def config():
    """Load configuration from environment."""
    # Load .env file
    env_file = Path(".env")
    if env_file.exists():
        load_dotenv(env_file)
        logger.info(f"Loaded environment from {env_file}")
    
    # Create and return config
    config = Config()
    config.validate()
    config.ensure_directories()
    return config


@pytest.fixture
def api_client(config):
    """Create API client with base URL and timeout."""
    session = requests.Session()
    session.base_url = config.api_base_url
    session.timeout = config.api_timeout
    
    # Add custom request method
    def request(method, url, **kwargs):
        if not url.startswith("http"):
            url = f"{session.base_url}{url}"
        return session.request(method, url, timeout=session.timeout, **kwargs)
    
    session.request = request
    return session


@pytest.fixture
def auth_headers(config):
    """Get authentication headers."""
    headers = config.get_auth_headers()
    logger.debug(f"Auth headers: {list(headers.keys())}")
    return headers


@pytest.fixture
def test_data():
    """Provide test data for various scenarios."""
    return {
        "valid_data": {
            "name": "Test Agent",
            "email": "test@example.com",
            "commissionTier": 10,
        },
        "invalid_data": {
            "name": "Test Agent",
            # Missing required fields
        },
        "edge_case_data": {
            "name": "",  # Empty string
            "email": "test@example.com",
            "commissionTier": 0,  # Boundary value
        },
    }


@pytest.fixture(autouse=True)
def log_test_info(request):
    """Log test information."""
    logger.info(f"Starting test: {request.node.name}")
    yield
    logger.info(f"Completed test: {request.node.name}")


def pytest_configure(config):
    """Configure pytest."""
    config.addinivalue_line(
        "markers", "happy_path: Happy path test cases"
    )
    config.addinivalue_line(
        "markers", "edge_case: Edge case test cases"
    )
    config.addinivalue_line(
        "markers", "error_scenario: Error scenario test cases"
    )
    config.addinivalue_line(
        "markers", "security: Security test cases"
    )
    config.addinivalue_line(
        "markers", "integration: Integration test cases"
    )
    config.addinivalue_line(
        "markers", "performance: Performance test cases"
    )
